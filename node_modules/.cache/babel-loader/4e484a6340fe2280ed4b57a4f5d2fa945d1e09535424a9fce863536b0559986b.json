{"ast":null,"code":"import React,{useCallback,useEffect,useMemo,useRef,useState}from'react';import{NavLink,useParams}from'react-router-dom';import{useDispatch}from'react-redux';import{toast}from'react-toastify';import Accord from'components/accord';import{formatCurrencyUZS}from'utils';import{useOutsideClick}from'utils/hooks';// import { departments, sendMessageTelegram } from 'utils/constants';\nimport{getRequest,postRequest}from'services/api';import{useLocaleOrders,useOrders,useProducts,useUser}from'../redux/selectors';import{setRoomCompleted}from'../redux/localeOrders';import OrderList from'components/order-list';// import axios from 'axios';\nimport{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const Order=()=>{var _oldOrders$products,_formatCurrencyUZS,_formatCurrencyUZS2,_formatCurrencyUZS3;const dispatch=useDispatch();const user=useUser();const localeOrders=useLocaleOrders();const products=useProducts();const orders=useOrders();const{id}=useParams();const modal=useRef();const[loading,setLoading]=useState();const[isOrderMore,setIsOrderMore]=useState({open:false});const[oldOrders,setOldOrders]=useState({});// const rooms = useRooms();\n// const thisRoom = useMemo(() => rooms?.find((rooms) => rooms.id === id), [rooms, id]);\nconst thisRoomOrders=useMemo(()=>{var _localeOrders$find;return localeOrders===null||localeOrders===void 0?void 0:(_localeOrders$find=localeOrders.find(rooms=>rooms.room===id))===null||_localeOrders$find===void 0?void 0:_localeOrders$find.recs;},[localeOrders,id]);const sumWithInitial=thisRoomOrders===null||thisRoomOrders===void 0?void 0:thisRoomOrders.reduce((accumulator,currentValue)=>{return Number(accumulator)+Number(currentValue.sell_price*currentValue.count);},[]);const menus=useMemo(()=>{const types=[...new Set(products===null||products===void 0?void 0:products.map(_ref=>{let{category}=_ref;return category===null||category===void 0?void 0:category.name;}))];return types===null||types===void 0?void 0:types.map(_category_name=>{return{name:_category_name,menus:products===null||products===void 0?void 0:products.filter(_ref2=>{let{category}=_ref2;return(category===null||category===void 0?void 0:category.name)===_category_name;})};});},[products]);const isOrder=useMemo(()=>orders===null||orders===void 0?void 0:orders.find(order=>(order===null||order===void 0?void 0:order.room_id)===id),[orders,id]);const getOldOrders=useCallback(()=>{getRequest(\"room/get/\".concat(id),user===null||user===void 0?void 0:user.token).then(_ref3=>{var _data$result,_data$result$products;let{data}=_ref3;setOldOrders(data===null||data===void 0?void 0:data.result);if(!(data!==null&&data!==void 0&&(_data$result=data.result)!==null&&_data$result!==void 0&&(_data$result$products=_data$result.products)!==null&&_data$result$products!==void 0&&_data$result$products.length)){setIsOrderMore({open:false});}}).catch(err=>{var _err$response,_err$response$data;toast.error(err===null||err===void 0?void 0:(_err$response=err.response)===null||_err$response===void 0?void 0:(_err$response$data=_err$response.data)===null||_err$response$data===void 0?void 0:_err$response$data.result);});},[id,user===null||user===void 0?void 0:user.token]);useEffect(()=>{getOldOrders();},[getOldOrders]);const handleAddCart=()=>{setLoading(true);postRequest('room/merge',{room_id:id,products_id:thisRoomOrders===null||thisRoomOrders===void 0?void 0:thisRoomOrders.map(_ref4=>{let{id}=_ref4;return id;}),products_quantity:thisRoomOrders===null||thisRoomOrders===void 0?void 0:thisRoomOrders.map(_ref5=>{let{count}=_ref5;return count;}),action:'plus'},user===null||user===void 0?void 0:user.token).then(_ref6=>{let{data}=_ref6;setLoading(false);getOldOrders();toast.success(data===null||data===void 0?void 0:data.result);dispatch(setRoomCompleted({room:id}));}).catch(err=>{var _err$response2,_err$response2$data;toast.error((err===null||err===void 0?void 0:(_err$response2=err.response)===null||_err$response2===void 0?void 0:(_err$response2$data=_err$response2.data)===null||_err$response2$data===void 0?void 0:_err$response2$data.result)||'Error');setLoading(false);});};const handleOpenDetails=()=>{setIsOrderMore({open:true});};// const handleCancel = (order_id) => {\n//   setLoading(true);\n//   deleteRequest(`order/${order_id}`, user?.token)\n//     .then(({ data }) => {\n//       setLoading(false);\n//       toast.info(data?.message);\n//       dispatch(setRoomCompleted({ room: id }));\n//       getRequest('order', user?.token)\n//         .then((orders) => {\n//           dispatch(setOrders(orders?.data?.result));\n//           setLoading(false);\n//           dispatch(setRoomCompleted({ room: id }));\n//         })\n//         .catch((err) => {\n//           toast.error(err?.response?.data?.result || 'Error');\n//           setLoading(false);\n//         });\n//       navigate('/rooms');\n//     })\n//     .catch((err) => {\n//       setLoading(false);\n//       toast.error(err?.response?.data?.result);\n//     });\n// };\nconst handleComplete=()=>{setLoading(true);getRequest(\"room/end/\".concat(id),user===null||user===void 0?void 0:user.token).then(_ref7=>{let{data}=_ref7;setLoading(false);toast.success(data===null||data===void 0?void 0:data.result);dispatch(setRoomCompleted({room:id}));getOldOrders();setIsOrderMore({open:false});}).catch(err=>{var _err$response3,_err$response3$data;setLoading(false);toast.error(err===null||err===void 0?void 0:(_err$response3=err.response)===null||_err$response3===void 0?void 0:(_err$response3$data=_err$response3.data)===null||_err$response3$data===void 0?void 0:_err$response3$data.result);});};useOutsideClick(modal,()=>setIsOrderMore({open:false}));return/*#__PURE__*/_jsxs(\"div\",{className:\"container-md\",children:[isOrderMore.open&&/*#__PURE__*/_jsx(\"div\",{className:\"modal modal-prods\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"modal-body\",ref:modal,children:[/*#__PURE__*/_jsxs(\"div\",{className:\"top\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"row-header\",children:/*#__PURE__*/_jsx(\"button\",{onClick:()=>setIsOrderMore({open:false}),children:\"Ortga\"})}),/*#__PURE__*/_jsxs(\"ol\",{className:\"alternating-colors\",children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Buyurtma ma'lumotlari\"}),oldOrders===null||oldOrders===void 0?void 0:(_oldOrders$products=oldOrders.products)===null||_oldOrders$products===void 0?void 0:_oldOrders$products.map(product=>{var _products$find;return/*#__PURE__*/_jsx(OrderList,{product:{...product,id:products===null||products===void 0?void 0:(_products$find=products.find(_ref8=>{let{name}=_ref8;return name===(product===null||product===void 0?void 0:product.name);}))===null||_products$find===void 0?void 0:_products$find.id},loading:loading,setLoading:setLoading,room:id,token:user===null||user===void 0?void 0:user.token,onUpdated:()=>getOldOrders()},product===null||product===void 0?void 0:product.name);})]})]}),/*#__PURE__*/_jsxs(\"button\",{className:\"order-btn full-btn\",onClick:handleComplete,children:[\"Buyurtmani yopish \",(oldOrders===null||oldOrders===void 0?void 0:oldOrders.total)&&\"\".concat((_formatCurrencyUZS=formatCurrencyUZS(oldOrders===null||oldOrders===void 0?void 0:oldOrders.total))===null||_formatCurrencyUZS===void 0?void 0:_formatCurrencyUZS.replace('UZS',''),\" UZS\")]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"row-header\",children:[/*#__PURE__*/_jsx(NavLink,{to:'/rooms',children:/*#__PURE__*/_jsx(\"button\",{children:\"Ortga qaytish\"})}),/*#__PURE__*/_jsx(\"h1\",{className:\"full\",children:\"Menu\"})]}),menus.map((room,key)=>/*#__PURE__*/_jsx(Accord,{defaultOpened:!key,room:room,id:id,thisRoomOrders:thisRoomOrders},key)),/*#__PURE__*/_jsxs(\"div\",{className:\"bottom-btns\",children:[oldOrders!==null&&oldOrders!==void 0&&oldOrders.total?/*#__PURE__*/_jsx(\"button\",{className:\"order-btn\",disabled:loading,onClick:()=>handleOpenDetails(isOrder===null||isOrder===void 0?void 0:isOrder.id),children:loading?/*#__PURE__*/_jsx(\"div\",{className:\"lds-dual-ring\"}):/*#__PURE__*/_jsxs(\"span\",{children:[\"Buyurtmani yopish \",(oldOrders===null||oldOrders===void 0?void 0:oldOrders.total)&&\"\".concat((_formatCurrencyUZS2=formatCurrencyUZS(oldOrders===null||oldOrders===void 0?void 0:oldOrders.total))===null||_formatCurrencyUZS2===void 0?void 0:_formatCurrencyUZS2.replace('UZS',''),\" UZS\")]})}):'',thisRoomOrders!==null&&thisRoomOrders!==void 0&&thisRoomOrders.length?/*#__PURE__*/_jsx(\"button\",{disabled:loading,className:\"order-btn\",onClick:handleAddCart,children:loading?/*#__PURE__*/_jsx(\"div\",{className:\"lds-dual-ring\"}):/*#__PURE__*/_jsxs(\"span\",{children:[\"Buyurtma berish \",sumWithInitial&&\"\".concat((_formatCurrencyUZS3=formatCurrencyUZS(sumWithInitial))===null||_formatCurrencyUZS3===void 0?void 0:_formatCurrencyUZS3.replace('UZS',''),\" UZS\")]})}):'']})]});};export default Order;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}